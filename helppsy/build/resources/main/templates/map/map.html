<!DOCTYPE html>
<!-- https://www.data.go.kr/data/3052419/openapi.do -->
<!-- https://www.vworld.kr/dev/v4dv_opn2dmap2guide_s001.do -->
<html lang=kor xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>지도 실험장</title>
</head>
<script type="text/javascript"
    src="https://map.vworld.kr/js/vworldMapInit.js.do?version=2.0&apiKey=CEB52025-E065-364C-9DBA-44880E3B02B8"></script>
<!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.css" type="text/css"> -->

<body>
    <div th:insert="~{/start:: menu}"></div> <!-- th:insert / th:replace 도 가능 -->
    <h3>지도 페이지</h3>
    <div style="display: flex;">
        <div id="vmap" style="width:80%; height:80%; left:0px; top:0px"></div>
        <div style="width:20%; height:80%; left:10px; top:0px">
            <div style="margin: 10px;">
                <form th:action="@{/mapmarker}" th:object="${mapmarker}" method="post">
                    <!--                <form th:action="@{/map/mapmarker}" method="post">-->
                    <p>
                        <!-- <span><label for="lon"></label><input type="text" id="lon" th:field="*{lon}"></span>
                        <span><label for="lat"></label><input type="text" id="lat" th:field="*{lat}"></span>
                        <span><label for="regX"></label><input type="text" id="regX" th:field="*{regX}"></span>
                        <span><label for="regY"></label><input type="text" id="regY" th:field="*{regY}"></span> -->
                        <span><input type="text" id="lon" name="lon" /></span>
                        <span><input type="text" id="lat" name="lat" /></span>
                        <span><input type="text" id="regX" name="regX" /></span>
                        <span><input type="text" id="regY" name="regY" /></span>
                    </p>
                    <p>
                        <textarea style="width: 90%;" id="content" rows="3" name="content"
                            placeholder="작성하실 메모를 입력하세요"></textarea>
                        <input type="submit" value="작성">
                        <!-- <button onclick="regMarker()">작성</button> -->
                    </p>
                    <p id="geoURL"></p>
                    <input type="hidden" name="apiKey" value="CEB52025-E065-364C-9DBA-44880E3B02B8" />
                    <p><span id="geoAddress"></span></p>
                    <p><span id="geoRoad"></span></p>
                    <p id="gw"></p>
                    <p id="regm">
                        <!-- <span><input type="hidden" id="lon" name="lon" /></span>
                        <span><input type="hidden" id="lat" name="lat" /></span>
                        <span><input type="hidden" id="regX" name="legX" /></span>
                        <span><input type="hidden" id="regY" name="legY" /></span> -->
                    </p>
                </form>
            </div>
        </div>
    </div>
    <div class="search_div">
        <span>
            <select class='search_type'>
                <option value="both">지번/도로명</option>
                <option value="parcel">지번</option>
                <option value="road">도로명</option>
            </select>
        </span>
        <span><input type="text" id="search" placeholder="검색할 장소를 입력하세요."></span>
        <span><button class="search_btn">검색</button></span>
    </div><br>

    <div id="buttons">
        <button type="button" onclick="javascript:move(14129709.590359,4512313.7639686,15);">여의도</button>
        <button type="button" onclick="javascript:move(14679304.585522275, 4472545.1240446,14);">독도</button>
    </div>
    <!-- <button type="button" onclick="removeMarker()">마커 지우기</button> -->

    <!-- <form id="searchForm" action="#" class="form_data" onsubmit="return false;search();">
        <input type="hidden" name="page" value="1" />
        <input type="hidden" name="type" value="PLACE" />
        <select id="typeSelect" name="type" onchange="searchSetting(this.value);"
            style="margin-bottom: 10px; height: 30px;">
            <option value="place" selected="selected">POI 검색</option>
            <option value="address">주소검색</option>
        </select>
        <select name="category_select" style="display: none;margin-bottom: 10px; height: 30px;">
            <option value="parcel">지번주소</option>
            <option value="road">도로명주소</option>
        </select>
        <input type="hidden" name="category" value="" />
        <input type="hidden" name="request" value="search" />
        <input type="hidden" name="apiKey" value="CEB52025-E065-364C-9DBA-44880E3B02B8">
        <input type="hidden" name="domain" value="http://localhost:8080">
        <input type="hidden" name="crs" value="EPSG:4326" />
        <input type="hidden" name="bbox" value="" />
        <div>
            <input type="text" id="searchValue" name="query" value="야탑역" style="width: 100px; height: 30px;" /> <a
                href="javascript:search();">검색</a>
            현재지도내 검색 <input type="checkbox" id="bbox_check">
        </div>
    </form>
    <div>
        <ul id="result">
            <li>
            </li>
        </ul>
    </div> -->

    <div th:insert="~{/mainPage:: footer}"></div>
</body>
<script>
    //var vmap;                                                               // 기본 지도를 받을 변수
    var markerLayer;                                                        // 마커 레이어를 받을 변수
    var x, y;                                                               // 클릭한 위경도를 받을 변수
    var checkRoadView = false;
    var key = "CEB52025-E065-364C-9DBA-44880E3B02B8";                       // 브이월드 인증키
    var titleName;                                                          // 마커에 표시될 검색방법 타이틀
    //vw.ol3.CameraPosition.center = [14145868.603246644, 4516117.737187111]; // 기본 지도 시작 중심 좌표 지정(세종대)
    //vw.ol3.CameraPosition.zoom = 16;                                        // 시작 Zoom 레벨

    vw.ol3.MapOptions = {   // 기본지도의 옵션
        basemapType: vw.ol3.BasemapType.GRAPHIC
        , controlDensity: vw.ol3.DensityType.EMPTY
        , interactionDensity: vw.ol3.DensityType.BASIC
        , controlsAutoArrange: true
        , homePosition: vw.ol3.CameraPosition
        , initPosition: vw.ol3.CameraPosition
    };
    var vmap = new vw.ol3.Map("vmap", vw.ol3.MapOptions);   // 기본 지도 생성 

    // PanZoomBar
    var zoom = new vw.ol3.control.Zoom(vmap);
    zoom.delta = 1;
    zoom.sliderVisible = true;
    zoom.site = vw.ol3.SiteAlignType.TOP_RIGHT;  // or   "center-right"
    zoom.draw();
    vmap.addControl(zoom);

    // OverviewMap
    var oMap = new vw.ol3.control.OverviewMap(vmap);
    oMap.site = "bottom-right";  // or   vw.ol3.SiteAlignType.TOP_RIGHT
    oMap.draw();

    // 지도이동
    function move(x, y, z) {
        var _center = [x, y];
        var z = z;
        var pan = ol.animation.pan({
            duration: 2000,
            source: (vmap.getView().getCenter())
        });
        vmap.beforeRender(pan);
        vmap.getView().setCenter(_center);
        setTimeout("fnMoveZoom()", 3000);
    }
    function fnMoveZoom() {
        zoom = vmap.getView().getZoom();
        if (16 > zoom) {
            vmap.getView().setZoom(14);
        }
    };

    let selNum;
    var tansform = []
    // 지도 클릭 이벤트
    vmap.on('click', function (event) {
        var feature = vmap.forEachFeatureAtPixel(event.pixel, function (feature, layer) {   // 클릭한 좌표를 첫번째 인자로 주어 해당 위치에 있는 feature를 구하고 두번쨰 인자(함수)로 넘겨준다.
            if (layer != null && layer.className == 'vw.ol3.layer.Marker') {    // 해당 좌표에 마커 레이어가 있다면
                // for (let i=0; i<ml.length; i++) {
                //     if (ml[i][1].x == x && ml[i][1].y == y) {
                //         selNum = ml[i][1].num
                //         $('#gw').html(selNum);
                //     }
                // }
                return feature;
            } else {
                return false;
            }
        });

        if (!feature) {
            var coord = vmap.getCoordinateFromPixel(event.pixel);   // 마우스 커서 아래의 좌표값 구하기
            x = coord[0];
            y = coord[1];
            if (checkRoadView) {    // 로드뷰 실행
                tansform = ol.proj.transform([x, y], 'EPSG:3857', 'EPSG:4326')  // 브이월드 좌표계에서 다음 지도 좌표계로 변환 EPSG:3857=>EPSG:4326
                location.href = "https://map.kakao.com/link/roadview/" + tansform[1] + "," + tansform[0];   // 로드뷰 불러오기
            } else {
                addMarker(x, y);    // addMarker함수에 위경도 변수 넘기고 실행
                tansform = ol.proj.transform([x, y], 'EPSG:3857', 'EPSG:4326')
                console.log("v-world 좌표 :\n", x, y, "\n위도, 경도 :\n", tansform[0], tansform[1])
            }
        }
        let geoURL = document.getElementById("geoURL");
        geoURL.innerHTML = "위도: " + tansform[0] + " <br> 경도: " + tansform[1] +
            "<br> x: " + x + "<br> y: " + y + "<br>";
    });

    let addr, road, geoResult
    let num = 0;
    let ml = [];
    function addMarker(lon, lat) {
        vmap.removeLayer(markerLayer);                        // 기존의 마커가 있다면 제거. 마커는 1개만 존재.
        markerLayer = new vw.ol3.layer.Marker(vmap);            // 마커 객체 생성
        var typeName = $('.search_type option:selected').val(); // 선택한 검색 종류 값
        if (typeName == "both") {
            titleName = "주소";
        } else if (typeName == "parcel") {
            titleName = "지번 주소";
        } else if (typeName == "road") {
            titleName = "도로명 주소";
        }

        // (비동기)좌표를 주소로 변환하는 api, 도로명주소 검색의 경우 건물의 geometry 기반으로 도로명 주소값을 가지고 오기 때문에 건물 외의 것을 클릭하면 값이 없을 수 있습니다.
        // 브이월드 지도서비스에서 행정 주제도중 도로명주소건물 주제도에 해당 좌표값이 들어와야만 도로명 주소값을 리턴 받을 수 있습니다.
        $.ajax({
            type: 'GET',
            url: 'http://api.vworld.kr/req/address?',
            dataType: "jsonp",          // CORS 문제로 인해 브이월드에선 jsonp를 사용한다고 함
            data: {
                service: "address",
                version: "2.0",
                request: "getaddress",
                format: "json",     // 결과 포멧으로 xml 또는 json 타입으로 받아볼 수 있다.
                key: key,           // 브이월드 인증키
                type: typeName,     // 검색 타입으로 '도로명:road' 또는 '지번:parcel' 또는 '둘다:both' 중 선택
                crs: "epsg:3857",   // 브이월드 기본 좌표계
                point: lon + "," + lat, // 좌표
                zipcode: true,          // 우편번호 여부
                simple: false           // 간략 결과 여부
            },
            success: function (json_data) {
                //let gw = document.getElementById('gw');
                if (json_data.response.status == "NOT_FOUND") {
                    if (typeName == 'road') {
                        $('#geoAddress').html('');
                        $('#geoRoad').html('도로명 주소가 없습니다.');
                    } else {
                        $('#geoAddress').html("주소가 없습니다.");
                        $('#geoRoad').html('');
                    }
                    $('#gw').html("검색 결과가 없습니다.");
                } else {
                    //text = json_data.response.result[0].text   // 받아온 json데이터에서 주소를 추출                    
                    for (i in json_data.response.result) {
                        addri = json_data.response.result[i].text;
                        addr += addri + "<br>";
                        if (i == 0) { // 지번 주소
                            if (typeName == 'both' || typeName == 'parcel') {
                                geoResult = `지번 주소: ${addri}`;
                                $('#geoAddress').html(geoResult);
                                $('#geoRoad').html('');
                            } else if (typeName == 'road') {
                                geoResult = `도로명 주소: ${addri}`;
                                $('#geoAddress').html('');
                                $('#geoRoad').html(geoResult);
                            }
                        } else if (i == 1) {    // 도로명 주소
                            geoResult = `도로명 주소: ${addri}`;
                            $('#geoRoad').html(geoResult);
                        }
                    }
                    $('#gw').html(addr);
                }
                vw.ol3.markerOption = {  // 마커 옵션 설정
                    x: lon,
                    y: lat,
                    num: num,
                    epsg: "EPSG:3857",
                    title: titleName,
                    contents: addr,
                    iconUrl: 'http://map.vworld.kr/images/ol3/marker_blue.png'
                };
                markerLayer.addMarker(vw.ol3.markerOption); // 마커 옵션을 마커에 적용
                vmap.addLayer(markerLayer);     // 마커를 vmap에 등록
                ml[num] = [markerLayer, vw.ol3.markerOption];
                num++;
                let mlgw = '';
                for (let i = 0; i < ml.length; i++) {
                    mlgw += ml[i][1].contents
                }
                //$('#gw').html(mlgw);
                regT0 = tansform[0];
                regT1 = tansform[1];
                regX = vw.ol3.markerOption.x;
                regY = vw.ol3.markerOption.y;
                regAddr = vw.ol3.markerOption.contents;
                $('#lon').val(regT0);
                $('#lat').val(regT1);
                $('#regX').val(regX);
                $('#regY').val(regY);
            },
            error: function (xtr, status, error) {
                alert(xtr + " : " + status + " : " + error);
            }
        });
        addri = '';
        addr = '';
    };

    function regMarker() {
        // regMarker = regT0+"<br>"+regT1+"<br>"+regX+"<br>"+regY+"<br>"+regAddr+"<br>"+regContent
        // $('#regm').html(regMarker);
    }

    // 마커 지우기 버튼 (현재 더미)
    /*     var removeMarker = false;
        function removeMarker() {
            if (removeMarker == false) {
                removeMarker = true;
            } else {
                removeMarker = true;
            }
        } */

    /*     for (let o in json_data.response.result.items) {
            if (o == 0) {
                //첫번째인자로 이동
                move(data.response.result.items[o].point.x, data.response.result.items[o].point.y, 15);
            }
            vw.ol3.markerOption = {
                x: data.response.result.items[o].point.x,
                y: data.response.result.items[o].point.y,
                epsg: "EPSG:3857",
                title: data.response.result.items[o].title,
                contents: data.response.result.items[o].address.parcel,
                iconUrl: 'http://map.vworld.kr/images/ol3/marker_black.png'
            };
        } */

    // 지도 검색
    // $('.search_btn').on('click', function () {
    //     vmap.removeLayer(markerLayer);                              // 기존의 마커 제거
    //     markerLayer = new vw.ol3.layer.Marker(vmap);                // 마커 객체 상성
    //     var contents_data;
    //     var typeName = $('.search_type option:selected').val();     // 선택한 검색 종류 값
    //     $.ajax({
    //         type: "get",
    //         url: "http://api.vworld.kr/req/search",
    //         data: {
    //             page: 1,
    //             type: 'address',                                    // 주소 검색방법
    //             category: typeName,                                 // 도로명 : road, 지번 : parcel
    //             request: 'search',
    //             apiKey: key,                                        // 브이월드 지도 인증기
    //             domain: 'http://localhost:8080/map.html',    //'본인의 map을 보여주는 도메인 ex) http://111.111.111.111/map.html'
    //             crs: 'EPSG:3857',                                  // 브이월드 좌표계
    //             query: $('#search').val()                          // 사용자가 입력한 text
    //         },
    //         dataType: 'jsonp',
    //         async: false,
    //         success: function (data) {
    //             if (data.response.status == "NOT_FOUND") {
    //                 alert("검색결과가 없습니다.");
    //             } else {
    //                 for (var o in data.response.result.items) {
    //                     if (o == 0) {
    //                         move(data.response.result.items[o].point.x * 1, data.response.result.items[o].point.y * 1);
    //                         if (typeName == "parcel") {
    //                             titleName = "지번 주소";
    //                             contents_data = data.response.result.items[o].address.parcel;
    //                         } else if (typeName == "road") {
    //                             titleName = "도로명 주소";
    //                             contents_data = data.response.result.items[o].address.road;
    //                         }
    //                     }
    //                     vw.ol3.markerOption = {                                         // 마커 옵션 설정
    //                         x: data.response.result.items[o].point.x,
    //                         y: data.response.result.items[o].point.y,
    //                         epsg: "EPSG:3857",
    //                         title: titleName,
    //                         contents: contents_data,
    //                         iconUrl: 'http://map.vworld.kr/images/ol3/marker_blue.png'
    //                     };
    //                     markerLayer.addMarker(vw.ol3.markerOption);                  // 마커 옵션을 마커에 적용
    //                 }
    //             }
    //         },
    //         complete: function () {
    //             vmap.addLayer(markerLayer)                                   // 마커를 vmap에 등록
    //         },
    //         error: function (xhr, status, error) {
    //             console.log(xhr, status, error);
    //         }
    //     });
    //     var move = function (x, y) {
    //         vmap.getView().setCenter([x, y]); // 지도 이동
    //         vmap.getView().setZoom(17);         // 줌레벨 설정
    //     }
    // });

    // 검색 #11page
    /* let search = function () {
        //검색 API 검색 설정
        let chk = false;
        chk = $('[name=category_select]').is(":visible");
        if (chk) {
            $('[name=category]').val($('[name=category_select]').val());
        } else {
            $('[name=category]').val("");
        }
        let bboxCheck = $('#bbox_check').is(":checked");

        //현재 화면 검색 설정
        if (bboxCheck) {
            var viewRect = ws3d.viewer.scene.camera.computeViewRectangle();
            var _html = "";
            var West = ws3d.common.CesiumMath.toDegrees(viewRect.west).toFixed(7) //long min
            var South = ws3d.common.CesiumMath.toDegrees(viewRect.south).toFixed(7) //lan min
            var East = ws3d.common.CesiumMath.toDegrees(viewRect.east).toFixed(7) //long max
            var North = ws3d.common.CesiumMath.toDegrees(viewRect.north).toFixed(7) //lan max
            $('[name=bbox]').val(`${West},${South},${East},${North}`);
        } else {
        }
        // jquery ajax 비동기 통신
        $.ajax({
            type: "get",
            url: "http://api.vworld.kr/req/search",
            data: $('#searchForm').serialize(),
            dataType: 'jsonp', //cors 우회를 위해 jsonp 이용
            async: false,
            beforeSend: map.clear(),
            success: function (data) {
                var resultHtml = "";
                if (data.response.status == "NOT_FOUND") {
                    resultHtml = `<li>검색결과가 없습니다.</li>`;
                } else {
                    for (let o in data.response.result.items) {
                        let mx = data.response.result.items[o].point.x * 1;
                        let my = data.response.result.items[o].point.y * 1;
                        if (o == 0) {
                            //첫번째인자로 이동
                            move(mx, my, 500);
                        }
                        var title = data.response.result.items[o].title;// map.getLayerNmElement( title ) 제어 가능
                        var bldnm = data.response.result.items[o].address.bldnm;
                        var parcel = data.response.result.items[o].address.parcel;
                        var road = data.response.result.items[o].address.road;
                        var markerhtml = "";
                        if (!chk) {
                            markerhtml = `<div class="vworld-info-window"><h2>${title}</h2><p><b>검색 주소</b>${parcel}<br></p>`;
                            resultHtml += `<li style="margin: 10px"><p onclick='move(${mx},${my},500)'>${(o * 1 + 1)} parcel: ${parcel} road : ${road}
                            ${title == null ? '' : 'title : ' + title}</p></li>`;
                        } else {
                            title = data.response.result.items[o].id;
                            if ($('[name=category]').val() == "parcel") {
                                markerhtml = `<div class="vworld-info-window"><h2>${bldnm}</h2><p><b>검색 주소</b>${parcel}<br></p>`
                            } else {
                                markerhtml = `<div class="vworld-info-window"><h2>${bldnm}</h2><p><b>검색 주소</b>${road}<br></p>`
                            }
                            resultHtml += `<li style="margin: 10px"><p onclick='move(${mx},${my},500)'>${(o * 1 + 1)} parcel: ${parcel} road : ${road}
                            ${bldnm == null ? '' : 'bldnm : ' + bldnm}</p></li>`;
                        }
                        map.createMarker(title // text 안나옴
                            , mx
                            , my
                            , markerhtml
                            , "http://map.vworld.kr/images/op02/map_point.png"
                        );
                    }
                }//else 종료
                $('#result').html(resultHtml);
            },
            complete: function () {
            },
            error: function (xhr, stat, err) { }
        });
    } */
    // 이동함수 구현
    /*     let move = function (x, y, z) {
            var movePo = new vw.CoordZ(x, y, z);
            var mPosi = new vw.CameraPosition(movePo, new vw.Direction(0, -90, 0));
            map.moveTo(mPosi);
        } */
    /*     let searchSetting = function (thisVal) {
            console.log(thisVal);
            if ("address" == thisVal) {
                $('[name=category_select]').show();
            } else {
                $('[name=category_select]').hide();
            }
        } */

    // // popup
    // var pop = null;
    // vmap.on("click", function (evt) {
    //     var coordinate = evt.coordinate;
    //     var hdms = ol.coordinate.toStringHDMS(ol.proj.transform(coordinate, "EPSG:3857", "EPSG:4326"));
    //     // var hdms = ol.coordinate.toStringHDMS(ol.proj.transform(coordinate, "EPSG:3857", "EPSG:4326"));
    //     // var hdms = "팝업예제";
    //     var content = hdms;
    //     if (pop == null) {
    //         pop = new vw.ol3.popup.Popup();
    //     }
    //     pop.title = "위치";
    //     pop.content = "오픈 API 2.0 WEB";
    //     vmap.addOverlay(pop);
    //     pop.show(content, coordinate);


    //     /* 지도이동 후 지오코더 호출  */
    //     // let center = vmap.getView().getCenter();
    //     // feature.getGeometry().setCoordinates(center)
    //     // geocoder_reverse(center[0], center[1]);

    //     let gw = document.getElementById("gw")
    //     gw.innerHTML = hdms;
    // }
    // );


    // 도로명 주소, 지번

    // vmap.getView().setCenter([14146386.272122687, 4526001.583379886]);
    // vmap.getView().setZoom(19);
    // let feature = new ol.Feature({
    //     geometry: new ol.geom.Point([14146386.272122687, 4526001.583379886]),
    // });

    // let addr, road;
    // let geocoder_reverse = function (x, y) {
    //     let geoResult, addr, road, roadNo, lawNo, law;
    //     $('#geoRoad').html("");
    //     $.ajax({
    //         type: "get",
    //         //url: "https://api.vworld.kr/req/address?service=address&version=2.0&request=getaddress&format=json&type=both&crs=epsg:900913",
    //         url: "https://api.vworld.kr/req/address?service=address&request=getAddress&version=2.0&crs=epsg:4326&point=126.978275264,37.566642192&format=xml&type=both&zipcode=true&simple=false&key=CEB52025-E065-364C-9DBA-44880E3B02B8",

    //         data: { apiKey: $('[name=apiKey]').val(), point: x + "," + y },
    //         dataType: 'jsonp',
    //         success: function (data) {
    //             turl = x + "," + y;
    //             $('#geoURL').html(`<a href="${turl}" target="_blank" style="color: red;">${turl}</a>`)

    //             if (data.response.status == 'NOT_FOUND') {
    //                 $('#geoRoad').html("검색결과 없음");
    //                 $('#geoAddress').html("");
    //                 return;
    //             }
    //             for (i in data.response.result) {
    //                 addr = data.response.result[i].text;
    //                 level4A = data.response.result[i].structure.level4A;
    //                 level4AC = data.response.result[i].structure.level4AC;
    //                 level4L = data.response.result[i].structure.level4L;
    //                 level4LC = data.response.result[i].structure.level4LC;

    //                 if (i == 0) { // 지번 주소
    //                     geoResult = `지 번 주소=${addr}`;
    //                     $('#geoAddress').html(geoResult);

    //                 } else if (i == 1) {//도로명 주소
    //                     geoResult = `도로명 주소=${addr}`;
    //                     $('#geoRoad').html(geoResult);
    //                 }
    //             }
    //         },
    //         beforeSend: function () {
    //         }, complete: function () {
    //         },
    //         error: function (xhr, stat, err) { }
    //     });
    // }
</script>

</html>