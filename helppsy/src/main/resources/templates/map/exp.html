<!DOCTYPE html>
<!-- 
	WebGL 3D 지도 검색 API 결과에 마커 생성
 -->
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>3D 지도생성 </title>
    <script type="text/javascript"
        src="https://map.vworld.kr/js/webglMapInit.js.do?version=2.0&apiKey=CEB52025-E065-364C-9DBA-44880E3B02B8"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.css" type="text/css">
</head>

<body>
    <div style="display: flex;">
        <div id="vmap" style="width:80%; height:80%; left:0px; top:0px"></div>
        <div style="width:20%; height:80%; left:10px; top:0px">
            <div style="margin: 10px;">
                <!--                <form th:action="@{/mapmarker}" th:object="${mapmarker}" method="post">-->
                <!-- <form th:action="@{/map/mapmarker}" method="post">-->
                <div>
                    <span><input type="hidden" id="lon" name="lon" /></span>
                    <span><input type="hidden" id="lat" name="lat" /></span>
                    <span><input type="hidden" id="regX" name="regX" /></span>
                    <span><input type="hidden" id="regY" name="regY" /></span>
                </div>
                <p>
                    <textarea style="width: 90%;" id="content" rows="3" name="content"
                        placeholder="작성하실 메모를 입력하세요"></textarea>
                    <input type="button" value="작성" onclick="submit()">
                </p>
                <p id="geoURL"></p>
                <input type="hidden" name="apiKey" value="CEB52025-E065-364C-9DBA-44880E3B02B8" />
                <p><span id="geoAddress"></span></p>
                <p><span id="geoRoad"></span></p>
                <p id="gw"></p>
                <p id="regm"></p>
            </div>
        </div>
    </div>
    <div>
        <button type="button" onclick="javascript:addMarkerLayer();">등록마커부르기</button>
        <button type="button" onclick="javascript:hideMarker();">마커숨기기</button>
        <button type="button" onclick="javascript:showMarker();">마커보기</button>
        <button type="button" onclick="javascript:showAllMarker();">마커전체보기</button>
        <button type="button" onclick="javascript:hideAllMarker();">마커전체숨기기</button>
    </div>
    <div>
        <button type="button" onclick="javascript:removeMarkerLayer();">등록마커삭제</button>
        <button type="button" onclick="javascript:removeMarker();">마커삭제</button>
        <button type="button" onclick="javascript:removeAllMarker();">마커전체삭제</button>
        <button type="button" onclick="javascript:showPopup();">마커팝업열기</button>
        <button type="button" onclick="javascript:hidePopup();">마커팝업닫기</button>
        <input type="text" id="param" value="" size="20" />
    </div>
    <div class="search_div">
        <span>
            <select class='search_type'>
                <option value="both">지번/도로명</option>
                <option value="parcel">지번</option>
                <option value="road">도로명</option>
            </select>
        </span>
        <span><input type="text" id="search" placeholder="검색할 장소를 입력하세요."></span>
        <span><button class="search_btn">검색</button></span>
    </div><br>

    <div>
        <form id="searchForm" action="#" class="form_data" onsubmit="return false;search();">
            <input type="hidden" name="page" value="1" />
            <!-- <input type="hidden" name="type" value="PLACE" /> -->
            <select id="typeSelect" name="type" onchange="searchSetting(this.value);"
                style="margin-bottom: 10px; height: 30px;">
                <option value="place" selected="selected">POI 검색</option>
                <option value="address">주소검색</option>
            </select>
            <select name="category_select" style="display: none;margin-bottom: 10px; height: 30px;">
                <option value="parcel">지번주소</option>
                <option value="road">도로명주소</option>
            </select>
            <input type="hidden" name="category" value="" />
            <input type="hidden" name="request" value="search" />
            <input type="hidden" name="domain" value="http://localhost:8080">
            <input type="hidden" name="crs" value="EPSG:4326" />
            <input type="hidden" name="bbox" value="" />
            <div>
                <input type="text" id="searchValue" name="query" value="야탑역" style="width: 100px; height: 30px;" /> <a
                    href="javascript:search();">검색</a>
                현재지도내 검색 <input type="checkbox" id="bbox_check">
            </div>
        </form>
    </div>
    <div>
        <ul id="result">
            <li>
            </li>
        </ul>
    </div>
</body>
<script>
    var vmap;               // 기본 지도를 받을 변수
    var markerLayer;        // 마커 레이어를 받을 변수
    //var nowMarkerLayer;     // 현재 지정한 마커 레이어
    var x, y;               // 클릭한 위경도를 받을 변수
    var checkRoadView = false;
    var key = "CEB52025-E065-364C-9DBA-44880E3B02B8";                       // 브이월드 인증키
    var titleName;                                                          // 마커에 표시될 검색방법 타이틀
    //vw.ol3.CameraPosition.center = [14145868.603246644, 4516117.737187111]; // 기본 지도 시작 중심 좌표 지정(세종대)
    //vw.ol3.CameraPosition.zoom = 16;                                        // 시작 Zoom 레벨
    var selectMarker;   // 선택한 마커


    let addr, road, geoResult, addr0, addr1;
    var typeName = $('.search_type option:selected').val(); // 선택한 검색 종류 값


    // let loadLon = $('.loadLon')[0].innerHTML; let loadLat = $('.loadLat')[0].innerHTML;
    // let loadX = $('.loadX')[0].innerHTML; let loadY = $('.loadY')[0].innerHTML;
    // let loadNum; let loadContent = $('.loadContent')[0].innerHTML; let markerLength = $('.loadContent').length
    // let loadNum; let loadLon ; let loadLat; let loadX; let loadY; let loadContent; let markerLength;

    function setLocation() {    // DB에서 불러온 지점에 마커 놓기
        for (let ml = 0; ml < markerLength; ml++) {
            loadLonTemp = $('.loadLon')[ml].innerHTML; loadLatTemp = $('.loadLat')[ml].innerHTML;
            loadXtemp = $('.loadX')[ml].innerHTML; loadYtemp = $('.loadY')[ml].innerHTML;
            loadNum = $('.loadNum')[ml].innerHTML; loadContentTemp = $('.loadContent')[ml].innerHTML;
            vw.ol3.markerOption = {
                x: loadXtemp * 1,   // 문자를 숫자로 변환하기 위해 일부러 1을 곱함
                y: loadYtemp * 1,
                epsg: "EPSG:3857",
                title: "메모",
                contents: loadContentTemp,
                text: {
                    offsetX: 0.5, //위치설정
                    offsetY: 20,   //위치설정
                    font: '12px Calibri,sans-serif',
                    fill: { color: '#000' },
                    stroke: { color: '#fff', width: 2 },
                    text: '마커 2번'
                },
                attr: { "num": loadNum, "longitude": loadLonTemp, "latitude": loadLatTemp }
            };
            markerLayer.addMarker(vw.ol3.markerOption); // 마커 옵션을 마커에 적용
        }
    }

    function getAddress() { // DB에서 불러온 마커를 클릭하면 주소를 불러옴
        $.ajax({
            type: 'GET',
            url: 'http://api.vworld.kr/req/address?',
            dataType: "jsonp",
            data: {
                service: "address",
                version: "2.0",
                request: "getaddress",
                format: "json",
                key: key,
                type: "both",
                crs: "epsg:3857",
                point: selX + "," + selY,
                zipcode: true,          // 우편번호 여부
                simple: false           // 간략 결과 여부
            },
            success: function (json_data) {
                if (json_data.response.status == "NOT_FOUND") {
                    $('#geoAddress').html("주소가 없습니다.");
                } else {
                    for (i in json_data.response.result) {
                        if (i == 0) { // 지번 주소
                            if (typeName == 'both' || typeName == 'parcel') {
                                addr0 = json_data.response.result[0].text;
                                geoResult = `지번 주소: ${addr0}`;
                                $('#geoAddress').html(geoResult);
                                $('#geoRoad').html('');
                            } else if (typeName == 'road') {
                                addr1 = json_data.response.result[1].text;
                                geoResult = `도로명 주소: ${addr1}`;
                                $('#geoAddress').html('');
                                $('#geoRoad').html(geoResult);
                            }
                        } else if (i == 1) {    // 도로명 주소
                            addr1 = json_data.response.result[1].text;
                            geoResult = `도로명 주소: ${addr1}`;
                            $('#geoRoad').html(geoResult);
                        }
                    }
                }
                //$('#geoURL').html(loadLon + "<br>" + loadLat + "<br>" + selX + "<br>" + selY);
                //$('#geoURL').html(selX + "<br>" + selY);
                //$('#geoAddress').html(addr);
            },
            error: function (xtr, status, error) {
                alert(xtr + " : " + status + " : " + error);
            }
        });
        //addri = '';
        //addr = '';
        addr0 = '';
        addr1 = '';
    }

    function isSelectMarker() {
        if (markerLayer == null) {
            alert("마커레이어가 생성되지 않았습니다. [등록마커부르기] 버튼을 먼저 실행하십시오.");
            return false;
        } else {
            // if (this.markerLayer.getSource().getFeatures().length < 1) {
            //     alert("생성된 마커가 없습니다.");
            //     return false;
            // } else {
            if ($('#param').val() == '') {
                alert("선택하실 마커를 눌러주세요. 마커가 선택되면 오른쪽에 마커의 ID가 표시됩니다.");
                return false;
            } else {
                return true;
            }
            //}
        }
    }

    function hideMarker() { // 마커 숨기기
        if (isSelectMarker()) {
            this.markerLayer.hideMarker(selectMarker);
        }
    }
    function showMarker() { // 마커 보이기
        if (isSelectMarker()) {
            this.markerLayer.showMarker(selectMarker);
            $('#param').val('');
        }
    }
    function hideAllMarker() {  // 마커 전체 숨기기
        if (markerLayer == null) {
            alert("마커레이어가 생성되지 않았습니다. [등록마커부르기] 버튼을 먼저 실행하십시오.");
        } else {
            this.markerLayer.hideAllMarker();
        }
    }
    function showAllMarker() {  // 마커 전체 보기
        this.markerLayer.showAllMarker();
    }
    function showPopup() {  // 팝업 보이기
        if (isSelectMarker()) {
            this.markerLayer.showPop(selectMarker);
        }
    }
    function hidePopup() {  // 팝업 숨기기
        if (isSelectMarker()) {
            this.markerLayer.hidePop(selectMarker);
        }
    }
    function removeMarker() {
        if (isSelectMarker()) {
            var features = this.markerLayer.getSource().getFeatures();
            for (let i = 0; i < features.length; i++) {
                if ($('#param').val() == features[i].get('id')) {
                    this.markerLayer.removeMarker(selectMarker);
                    $('#param').val('');
                    selectMarker = null;
                }
            }
        }
    }
    function removeAllMarker() { // 마커 전체 삭제
        if (markerLayer == null) {
            alert("마커레이어가 생성되지 않았습니다. [등록마커부르기] 버튼을 먼저 실행하십시오.");
        } else {
            this.markerLayer.removeAllMarker();
        }
    }
    function removeMarkerLayer() {   // DB에 저장된 마커를 지움
        if (isSelectMarker()) {
            if (confirm("선택한 마커를 삭제하시겠습니까?")) {
                //let num = selectMarker.values_.attr.index;
                location.href = "/map/delMarker/" + selectMarker.values_.attr.num;
            } else {
                return;
            }
        }
    }

    function addMarkerLayer() {
        //location.href = "/map/loadMarker";
        //if (markerLayer != null) {
        vmap.removeLayer(markerLayer);
        markerLayer = null;
        //} else {
        markerLayer = new vw.ol3.layer.Marker(vmap);    // 마커 객체 생성
        vmap.addLayer(markerLayer);     // 마커를 vmap에 등록
        setLocation();
        //}
    }

    function submit() { // [작성] 버튼을 누를 때 memoMode에 따라 마커를 등록(1)/수정(2)한다.
        if (memoMode == 1) {
            $.ajax({
                //async: true,    // 비동기 방식
                type: 'POST',
                url: '/map/addMarker',
                dataType: "html",
                data: {
                    lon: $('#lon').val(),
                    lat: $('#lat').val(),
                    regX: $('#regX').val(),
                    regY: $('#regY').val(),
                    content: $('#content').val(),
                    addr0: addr0,
                    addr1: addr1
                },
                success: function (data) {
                    alert("새로운 마커를 등록했습니다. 확인하시려면 새로고침하세요.")
                },
                error: function (xtr, status, error) {
                    alert(xtr + " : " + status + " : " + error);
                }
            });
        } else if (memoMode == 2) {
            $.ajax({
                //async: true,
                type: 'POST',
                url: '/map/modMarker',
                dataType: "html",
                data: {
                    num: selectMarker.values_.attr.num,
                    lon: $('#lon').val(),
                    lat: $('#lat').val(),
                    regX: $('#regX').val(),
                    regY: $('#regY').val(),
                    content: $('#content').val(),
                    addr0: addr0,
                    addr1: addr1
                    //addr: $('#gw').html()
                },
                success: function (data) {
                    alert("메모를 수정했습니다. 확인하시려면 새로고침하세요.")
                },
                error: function (xtr, status, error) {
                    alert(xtr + " : " + status + " : " + error);
                }
            });
        } else {
            alert("위치를 지정해주세요.");
            return;
        }
        location.href = "/map";
    }

    let mapOptions = new vw.MapOptions(
        vw.BasemapType.GRAPHIC, //2D 전용
        "", //layersArr 미사용 옵션
        vw.DensityType.FULL, //controlsDensity 2D 전용
        vw.DensityType.BASIC, //interactionDensity 2D 전용
        false, //controlAutoArrange 2D 전용
        new vw.CameraPosition(
            new vw.CoordZ(126.92775802528264, 37.52501881993892, 12416), //초기 위치 설정(경도, 위도, 높이 값)   
            new vw.Direction(0, -90, 0)
        ), //home
        new vw.CameraPosition(
            new vw.CoordZ(126.92775802528264, 37.52501881993892, 12416), //초기 위치 설정(경도, 위도, 높이 값)   
            new vw.Direction(0, -90, 0)
        )// initPosition
    );
    let map = new vw.Map("vmap", mapOptions);

    // 검색
    let search = function () {

        //검색 API 검색 설정
        let chk = false;
        chk = $('[name=category_select]').is(":visible");
        if (chk) {
            $('[name=category]').val($('[name=category_select]').val());
        } else {
            $('[name=category]').val("");
        }
        let bboxCheck = $('#bbox_check').is(":checked");

        //현재 화면 검색 설정
        if (bboxCheck) {
            var viewRect = ws3d.viewer.scene.camera.computeViewRectangle();
            var _html = "";
            var West = ws3d.common.CesiumMath.toDegrees(viewRect.west).toFixed(7) //long min
            var South = ws3d.common.CesiumMath.toDegrees(viewRect.south).toFixed(7) //lan min
            var East = ws3d.common.CesiumMath.toDegrees(viewRect.east).toFixed(7) //long max
            var North = ws3d.common.CesiumMath.toDegrees(viewRect.north).toFixed(7) //lan max
            $('[name=bbox]').val(`${West},${South},${East},${North}`);
        } else {
        }

        // jquery ajax 비동기 통신
        $.ajax({
            type: "get",
            url: "http://api.vworld.kr/req/search",
            data: $('#searchForm').serialize(),
            dataType: 'jsonp', //cors 우회를 위해 jsonp 이용
            async: false,
            beforeSend: map.clear(),
            success: function (data) {
                var resultHtml = "";
                if (data.response.status == "NOT_FOUND") {
                    resultHtml = `<li>검색결과가 없습니다.</li>`;
                } else {
                    for (let o in data.response.result.items) {
                        let mx = data.response.result.items[o].point.x * 1;
                        let my = data.response.result.items[o].point.y * 1;
                        if (o == 0) {
                            //첫번째인자로 이동
                            move(mx, my, 500);
                        }
                        var title = data.response.result.items[o].title;// map.getLayerNmElement( title ) 제어 가능
                        var bldnm = data.response.result.items[o].address.bldnm;
                        var parcel = data.response.result.items[o].address.parcel;
                        var road = data.response.result.items[o].address.road;
                        var markerhtml = "";
                        if (!chk) {
                            markerhtml = `<div class="vworld-info-window"><h2>${title}</h2><p><b>검색 주소</b>${parcel}<br></p>`;
                            resultHtml += `<li style="margin: 10px"><p onclick='move(${mx},${my},500)'>${(o * 1 + 1)} parcel: ${parcel} road : ${road} 
        							${title == null ? '' : 'title : ' + title}</p></li>`;
                        } else {
                            title = data.response.result.items[o].id;
                            if ($('[name=category]').val() == "parcel") {
                                markerhtml = `<div class="vworld-info-window"><h2>${bldnm}</h2><p><b>검색 주소</b>${parcel}<br></p>`
                            } else {
                                markerhtml = `<div class="vworld-info-window"><h2>${bldnm}</h2><p><b>검색 주소</b>${road}<br></p>`
                            }
                            resultHtml += `<li style="margin: 10px"><p onclick='move(${mx},${my},500)'>${(o * 1 + 1)} parcel: ${parcel} road : ${road} 
							${bldnm == null ? '' : 'bldnm : ' + bldnm}</p></li>`;
                        }
                        map.createMarker(title // text 안나옴 
                            , mx
                            , my
                            , markerhtml
                            , "http://map.vworld.kr/images/op02/map_point.png"
                        );
                    }
                }//else 종료
                $('#result').html(resultHtml);
            },
            complete: function () {
            },
            error: function (xhr, stat, err) { }
        });
    }
    /** 이동함수 구현
    */
    let move = function (x, y, z) {
        var movePo = new vw.CoordZ(x, y, z);
        var mPosi = new vw.CameraPosition(movePo, new vw.Direction(0, -90, 0));
        map.moveTo(mPosi);
    }

    let searchSetting = function (thisVal) {
        console.log(thisVal);
        if ("address" == thisVal) {
            $('[name=category_select]').show();
        } else {
            $('[name=category_select]').hide();
        }
    }
</script>

</html>